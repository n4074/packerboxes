{
  "variables": {
    "iso_url": "https://channels.nixos.org/nixos-20.03/latest-nixos-minimal-x86_64-linux.iso",
    "iso_checksum": "3ebbf9cd9bdff0c7394eaef408c5c4f816c2f1d044b6e140c7531bbd17be1c47",
    "iso_checksum_type": "sha256",
    "output_directory": "build/",
    "esxi_hostport": "22",
    "vm_name": "nixos-base",
    "http_directory": "."
  },
    "builders": [
    {
      "type": "vmware-iso",
      "name": "{{user `vm_name`}}",
      "vm_name": "{{ user `vm_name` }}",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "output_directory": "{{ user `output_directory` }}/{{ user `vm_name`}}",
      "http_directory": "{{user `http_directory`}}",
      "boot_wait": "3s",
      "boot_key_interval": "5ms",
      "boot_command": [
        "<down><enter><wait45s>",
        "sudo su<enter><wait1s>",
        "cat > /etc/ssh/ca.pub <<SSH_EOF<enter>",
        "{{user `ssh_ca_pub_key`}}<enter>",
        "SSH_EOF<enter>",
        "cp --remove-destination \"$(readlink /etc/ssh/sshd_config)\" /etc/ssh/sshd_config<enter>",
        "echo TrustedUserCAKeys /etc/ssh/ca.pub >> /etc/ssh/sshd_config<enter>",
        "systemctl start sshd<enter>"
      ],
      "disk_size": 81920,
      "memory": 8192,
      "cores": 2,
      "sound": true,
      "usb": true,
      "ssh_wait_timeout": "500s",
      "shutdown_command": "systemctl poweroff",
      "guest_os_type": "other4xlinux-64",
      "ssh_username": "root",
      "ssh_agent_auth": true,
      "ssh_private_key_file": "{{user `ssh_private_key`}}",
      "vnc_disable_password": true,
      "skip_export": true,
      "keep_registered": true,
      "vmx_data": { 
        "firmware": "efi",
        "mks.enable3d": "TRUE",
        "gui.fitGuestUsingNativeDisplayResolution": "TRUE",
        "gui.perVMFullscreenAutofitMode": "resize",
        "gui.perVMWindowAutofitMode":"resize"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "scripts":["partition.sh"]
    },
    {
      "type": "shell",
      "inline": [
        "nix-env -i git",
        "nixos-generate-config --root /mnt"
      ]
    },
    {
      "type": "file",
      "source": "configuration.nix",
      "destination": "/mnt/etc/nixos/configuration.nix"
    },
    {
      "type": "shell",
      "inline": [
        "nixos-install --root /mnt --show-trace",
        "cp {,/mnt}/etc/ssh/ca.pub",
        "ssh-keygen -t ed25519 -N \"\" -f /mnt/etc/ssh/ssh_host_ed25519_key"
      ]
    },
    {
      "type": "file",
      "direction": "download",
      "source": "/mnt/etc/ssh/ssh_host_ed25519_key.pub",
      "destination": "./ssh_host_ed25519_key.pub"
    },
    {
      "type": "shell-local",
      "inline": [
        "ssh-keygen -h -Us {{user `ssh_ca_pub_key`}} -I nixos-base -n nixos-base -V +365d ssh_host_ed25519_key.pub"
      ]
    },
    {
      "type": "file",
      "generated": true,
      "source": "ssh_host_ed25519_key-cert.pub",
      "destination": "/mnt/etc/ssh/ssh_host_ed25519_key-cert.pub"
    }
   ]
}
